---
title: "常见服务器解析漏洞"
date: "2024-11-30"
description: " IIS7.0中，在默认Fast-CGI开启状况下test.jpg/x.php，此时神奇的畸形解析开始发挥作用啦。test.jpg将会被服务器当成php文件执行.  "
---

#### [](#lls-6-0 "lls 6.0")lls 6.0

##### [](#目录解析 "目录解析")目录解析

```text
在 IIS5.x/6.0 中，在网站下建立文件夹的名字为*.asp、*.asa、*.cer、*.cdx 的文件夹，那么其目录内的任何扩展名的文件都会被IIS当做asp文件来解释并执行。例如创建目录 test.asp，那么 /test.asp/1.jpg 将被当做asp文件来执行。假设黑客可以控制上传文件夹路径，就可以不管上传后你的图片改不改名都能拿shell了
```

##### [](#文件解析 "文件解析")文件解析

```text
在 IIS5.x/6.0 中,分号后面的不被解析，也就是说 xie.asp;.jpg 会被服务器看成是xie.asp。还有IIS6.0默认的可执行文件除了asp还包含这两种 .asa   .cer 。而有些网站对用户上传的文件进行校验，只是校验其后缀名。所以我们只要上传 *.asp;.jpg、*.asa;.jpg、*.cer;.jpg 后缀的文件，就可以通过服务器校验，并且服务器会把它当成asp文件执行。
```

#### [](#lls-7-0 "lls 7.0")lls 7.0

 IIS7.0中，在默认Fast-CGI开启状况下test.jpg/x.php，此时神奇的畸形解析开始发挥作用啦。test.jpg将会被服务器当成php文件执行.

cgi.fix\_pathinfo，该值默认为1，表示开启。当 php 遇到文件路径 /aaa.xxx/bbb.yyy/ccc.zzz  时，若 /aaa.xxx/bbb.yyy/ccc.zzz 不存在，则会去掉最后的 /ccc.zzz ，然后判断 /aaa.xxx/bbb.yyy 是否存在，若存在，则把 /aaa.xxx/bbb.yyy 当做文件  /aaa.xxx/bbb.yyy/ccc.zzz ，若   /aaa.xxx/bbb.yyy  仍不存在，则继续去掉  /bbb.yyy

#### [](#漏洞原理 "漏洞原理")**漏洞原理**

Apache 解析文件的规则是从右到左开始判断解析,如果后缀名为不可识别文件解析,就再往左判断。比如 test.php.owf.rar “.owf”和”.rar” 这两种后缀是apache不可识别解析,apache就会把wooyun.php.owf.rar解析成php。

#### [](#漏洞形式 "漏洞形式")**漏洞形式**

[www.xxxx.xxx.com/test.php.xxx](http://www.xxxx.xxx.com/test.php.xxx)

**配置问题导致漏洞**

（1）如果在 Apache 的 conf 里有这样一行配置 AddHandler php5-script .php 这时只要文件名里包含.php 即使文件名是 test2.php.jpg 也会以 php 来执行。  
（2）如果在 Apache 的 conf 里有这样一行配置 AddType application/x-httpd-php .jpg 即使扩展名是 jpg，一样能以 php 方式执行。

#### [](#原理 "原理")原理

1、 由于nginx.conf的如下配置导致nginx把以’.php’结尾的文件交给fastcgi处理,为此可以构造[http://ip/uploadfiles/test.png/.php](http://ip/uploadfiles/test.png/.php)

2、但是fastcgi在处理’.php’文件时发现文件并不存在,这时php.ini配置文件中cgi.fix\_pathinfo=1 发挥作用,这项配置用于修复路径,如果当前路径不存在则采用上层路径。为此这里交由fastcgi处理的文件就变成了’/test.png’。 最重要的一点是php-fpm.conf中的security.limit\_extensions配置项限制了fastcgi解析文件的类型(即指定什么类型的文件当做代码解析),此项设置为空的时候才允许fastcgi将’.png’等文件当做代码解析。

**原理**

一般来讲，我们采用了 cgi 之后可以看到 它是逐层修复文件的，因为可以看到如果说他直接把php后缀的交给了服务器。但是最外层文件是不存在的，所以他会删掉，同时给出一个新的文件，但是可以看到我们的jpg是存在的就会解析我们的jpg作为php
